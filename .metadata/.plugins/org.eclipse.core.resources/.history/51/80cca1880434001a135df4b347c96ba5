package lixco.com.beans;

import java.io.IOException;
import java.util.ArrayList;
import java.util.List;

import javax.faces.application.ResourceHandler;
import javax.servlet.Filter;
import javax.servlet.FilterChain;
import javax.servlet.FilterConfig;
import javax.servlet.ServletException;
import javax.servlet.ServletRequest;
import javax.servlet.ServletResponse;
import javax.servlet.annotation.WebFilter;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import javax.servlet.http.HttpSession;

import lixco.com.entities.Role_Permission;

@WebFilter("/pages/admin/pagesadmin/*")
public class AuthorizationFilter implements Filter {

	@Override
	public void init(FilterConfig arg0) throws ServletException {
	}

	@SuppressWarnings({"unused", "unchecked" })
	public void doFilter(ServletRequest req, ServletResponse resp, FilterChain chain)
			throws IOException, ServletException {

		HttpServletRequest request = (HttpServletRequest) req;
		HttpServletResponse response = (HttpServletResponse) resp;
		HttpSession session = request.getSession(false);
		
		String homeURI = request.getContextPath() + "/pages/admin/pagesadmin/common.xhtml";
		
		boolean loggedIn = session != null && session.getAttribute("username") != null;
		boolean resourceRequest = request.getRequestURI()
				.startsWith(request.getContextPath() + ResourceHandler.RESOURCE_IDENTIFIER);
		
		String url = request.getRequestURL().toString();
		String uri = request.getRequestURI();
		List<Role_Permission> permissions = new ArrayList<>();
		permissions = (ArrayList<Role_Permission>)session.getAttribute("permissions");
		List<String> link = new ArrayList<>();
		for (int i = 0; i < permissions.size(); i++) {
			if( url.contains(permissions.get(i).getPermission().getLink())) {
				link.add(permissions.get(i).getPermission().getLink());
//				chain.doFilter(request, response);
				return;
			}
		}
		if((boolean)session.getAttribute("isAdmin")) {
			String urlTemp = request.getContextPath() + "/pages/admin/pagesadmin/capquyenchoaccount.xhtml";
			chain.doFilter(request, response);
			response.sendRedirect(urlTemp);
			return;
		}
		String url1 = "http://" + req.getServerName() + ":" + req.getServerPort() + "/WebTimViec_WEB/pages/admin/index.xhtml";
		response.sendRedirect(url1);
	}

	@Override
	public void destroy() {
	}

}